"use strict";var config={orderId:yo.getQueryString("id"),role:localStorage.userRole,api_getOrderDetail:"/order/getOrderDetail",api_showAll:"/order/showAll",api_saveLinkManInfo:"/order/saveLinkManInfo",api_saveProductAttach:"/order/saveProductAttach",api_updateDebtor:"/order/updateDebtor",api_saveLinkMan:"/linkman/saveLinkMan",api_updateLinkMans:"/saleCustomer/updateLinkMans",api_updateGjStatus:"/order/updateGjStatus",api_saveCallInfo:"/order/saveCallInfo",api_call:"/order/call.do",api_updateCallInfo:"/order/updateCallInfo"};require(["module_dialog_payplan","module_dialog_payplan_edit"],function(e,a){window.app=new Vue({el:"#app",data:{c:{},orderId:config.orderId,type:3,uploader:0,role:config.role,citys:{},editParam:"",hoverParam:"",oldData:"",posting:!1,sa:[],sb:[],sc:[],sd:[],se:[],openDialog:""},computed:{precalc:function(){var e=0;switch(this.c.status){case 0:e++}return!e},supplylaw:function(){var e=0;switch(this.c.status){case 0:e++}return!e},citys_sub:function(){var t=this.c.provinceName1,i=[],n=void 0;return $.each(this.citys["省份"],function(e,a){t==a.regionName&&(n=a.id)}),$.each(this.citys["市区"],function(e,a){n==a.parentId&&i.push(a)}),i},attachs:function(){var e=this.c.attachs,a={type:[]};for(var t in $.each(e,function(){for(var e in this)null==a[e]&&(a[e]=[]),a[e].push(this[e])}),a)a[t]=a[t].join(",");return a.orderId=config.orderId,a}},created:function(){document.getElementById("app").classList.remove("hide"),localStorage.citys&&(this.citys=JSON.parse(localStorage.citys)),this.getCaseDetail(),this.getCaseRecord()},mounted:function(){$(".showTips").hover(function(){var e=$(this).text();e&&"  "!=e&&(window.toolTips_TEMP=layer.yoTips('<span style="color:#337ab7">'+e+"</span>",this,{tips:[3,"#fff"]}))},function(){layer.close(window.toolTips_TEMP)})},directives:{focus:{inserted:function(e){e.focus(),"SELECT"==e.tagName&&$(e).select2({language:"zh-CN",placeholder:"请选择"}).on("select2:close",function(e){var a=e.target.value||app.c[app.editParam],t=$(this);if(app.c[app.editParam]==a)t.select2("destroy"),app.editParam="";else{switch(Vue.set(app.c,app.editParam,a),app.editParam){case"provinceName1":app.c.cityName1=""}Vue.nextTick(function(){app.saveData(),t.select2("destroy"),app.editParam=""})}}).select2("open")}}},methods:{enter:function(e){this.editParam!=e&&(this.hoverParam=e)},leave:function(){this.hoverParam==this.editParam&&(this.hoverParam="")},saveData:function(e){var a=this;if(!this.posting)if(""==this.c.debtorName&&(this.c.debtorName=this.oldData),this.oldData!=this.c[this.editParam]){var t={orderId:config.orderId,debtorId:this.c.debtorId};this.posting=!0,t[this.editParam]=this.c[this.editParam],this.editParam?$.post(config.api_updateDebtor,t,function(e){a.editParam="",a.posting=!1}):this.posting=!1}else this.editParam=""},change:function(e){this.hoverParam="",this.editParam=e,this.oldData=this.c[e]},loading:function(e){"close"==e?layer.close(this.loadingSwitch):this.loadingSwitch=layer.load(3)},getCaseDetail:function(){var a=this;a.loading(),$.ajax({url:config.api_getOrderDetail,async:!1,data:{id:config.orderId},success:function(e){a.c=e.result,a.loading("close")}})},getCaseRecord:function(e){var a=this;this.type=e||this.type,a.loading(),$.post(config.api_showAll,{orderId:config.orderId,type:a.type}).done(function(e){switch(a.loading("close"),a.type){case 3:a.sa=e.result;break;case 1:a.sb=e.result;break;case 6:a.sc=e.result;break;case 5:a.sd=e.result;break;case 2:a.se=e.result}})},linkman_add:function(){var i=this;require(["text!debtor_linkman_add"],function(e){var t=layer.open({type:1,title:"新增联系人",closeBtn:1,content:e,area:["600px","400px"],btn:"保存",btnAlign:"c",yes:function(){require(["yoValidate"],function(){if(yoValidate("#debtor_linkman_add",1)){var a={};$.each($("#debtor_linkman_add").find("input,textarea"),function(){a[this.name]=$.trim(this.value)}),a.debtorId=i.c.debtorId,i.loading(),$.post(config.api_saveLinkManInfo,a).done(function(e){i.loading("close"),i.c.linkMan6.push(a),layer.close(t)})}})}})})},linkman_edit:function(t){var i=this,n={name:t.name||t.zqrName||t.fzrName,mobilePhone:t.mobilePhone||t.zqrMobilePhone||t.fzrMobilePhone,landline:t.landline||t.zqrLandline||t.fzrLandline,email:t.email||t.zqrEmail||t.fzrEmail,postion:t.postion||t.zqrPostion||t.fzrPostion,fax:t.fax||t.zqrFax||t.fzrFax,remark:t.remark||t.zqrRemark||t.fzrRemark,id:t.id||t.linkId1||t.linkId2,customerId:i.c.debtorId};require(["text!debtor_linkman_add"],function(e){var a=layer.open({type:1,title:"编辑联系人",closeBtn:1,content:e,area:["600px","550px"],btn:"保存",btnAlign:"c",success:function(){$.each($("#debtor_linkman_add").find("input,textarea"),function(){this.value=n[this.name]||""})},yes:function(){require(["yoValidate"],function(){if(yoValidate("#debtor_linkman_add",1)){var e={};$.each($("#debtor_linkman_add").find("input,textarea"),function(){e[this.name]=$.trim(this.value)}),e.id=t.id||t.linkId1||t.linkId2,e.customerId=i.c.debtorId,i.loading(),$.post(config.api_updateLinkMans,e).done(function(e){i.loading("close"),i.getCaseDetail(),layer.close(a)})}})}})})},debtor_linkman_add:function(i){var n=this;require(["text!debtor_linkman_add"],function(e){var a=0==i?"新增债务知情人":"新增其他负责人",t=layer.open({type:1,title:a,closeBtn:1,content:e,area:["600px","500px"],btn:"保存",btnAlign:"c",yes:function(){require(["yoValidate"],function(){if(yoValidate("#debtor_linkman_add",1)){var e={orderId:config.orderId,customerId:n.c.debtorId,type:1,flag:i};$.each($("#debtor_linkman_add").find("input,textarea"),function(){e[this.name]=$.trim(this.value)}),n.loading(),$.post(config.api_saveLinkMan,e).done(function(e){n.loading("close"),n.getCaseDetail(),layer.close(t)})}})}})})},initUploader:function(){if(!("运作总监"!=this.role&&"公司内部运作"!=this.role&&"经理"!=this.role||this.uploader)){var t=this;this.loading(),require(["webuploader"],function(e){t.loading("close"),t.uploader=1;var a=e.create({server:"/contract/uploadAttachment.do",runtimeOrder:"html5",pick:{id:"#fileUp",innerHTML:"上传附件"},resize:!1,fileNumLimit:10});a.on("uploadSuccess",function(e,a){a.type="案件",t.c.attachs.push(a)}),a.on("uploadStart",function(){t.loading()}),a.on("uploadError",function(e){layer.msg("上传出错")}),a.on("error",function(e){"Q_TYPE_DENIED"==e&&layer.msg("上传文件格式错误，请检查")}),a.on("uploadFinished",function(e){a.reset(),$.post(config.api_saveProductAttach,t.attachs).done(function(){t.loading("close")})}),a.on("fileQueued",function(){a.upload()})})}},attachs_delete:function(e){var a=this,t=layer.confirm("确定删除此附件?",function(){a.c.attachs.splice(e,1),$.post(config.api_saveProductAttach,a.attachs).done(function(){a.loading("close"),layer.close(t)})})},record_add:function(p,u,e){var f=this,a="";switch(this.type){case 3:require(["text!follow_add"],function(e){var c=layer.open({type:1,title:"跟进记录",closeBtn:1,content:e,area:["600px","600px"],btn:"保存",btnAlign:"c",success:function(){if(laydate.render({elem:"#log_createTime",type:"datetime"}),laydate.render({elem:"#log_xcgjTime",type:"datetime"}),$("#log_createTime").val(f.getNowFormatDate()),$("#log_xcgjTime").val(),app.loading(),require(["webuploader"],function(e){app.loading("close");var a=e.create({server:"/contract/uploadAttachment.do",runtimeOrder:"html5",pick:{id:"#follow_fileUp",innerHTML:"上传附件"},resize:!1,fileNumLimit:10});a.on("uploadSuccess",function(e,a){var t=$(".file-list"),i='<div data-info="'+encodeURI(JSON.stringify(a))+'" class="alert alert-info alert-dismissable file-list-item"><button aria-hidden="true" data-dismiss="alert" class="close" type="button">×</button>';i+='<a href="'+a.url+'" target="_blank"> '+a.originalFilename+" </a></div>",t.append(i)}),a.on("uploadStart",function(){app.loading()}),a.on("uploadError",function(e){layer.msg("上传出错")}),a.on("error",function(e){"Q_TYPE_DENIED"==e&&layer.msg("上传文件格式错误，请检查")}),a.on("uploadFinished",function(e){a.reset(),$.post(config.api_saveProductAttach,f.attachs).done(function(){app.loading("close")})}),a.on("fileQueued",function(){a.upload()})}),1==p){var e=$("#follow_add"),a=f.sa[u];e.find("[name=link]").children('[value="'+a.link+'"]').prop("selected",!0),e.find("[name=gjStatus]").children('[value="'+a.gjStatus+'"]').prop("selected",!0),$("#log_createTime").val(a.createTime),e.find("[name=remark]").val(a.remark),$("#log_xcgjTime").val(a.xcgjTime);var t="";$.each(a.attachs,function(){this.id&&(this.attachId=this.id),t+='<div data-info="'+encodeURI(JSON.stringify(this))+'" class="alert alert-info alert-dismissable file-list-item"><button aria-hidden="true" data-dismiss="alert" class="close" type="button">×</button><a href="'+this.url+'" target="_blank"> '+this.originalFilename+" </a></div>"}),$(".file-list").html(t)}},yes:function(){if("call"!=p||top.callId){var e=$("#follow_add"),a={orderId:config.orderId,link:e.find("[name=link]").val(),gjStatus:e.find("[name=gjStatus]").val(),remark:e.find("[name=remark]").val(),createTime:$("#log_createTime").val(),xcgjTime:$("#log_xcgjTime").val(),debtorName:f.c.debtorName},t="/order/saveProcess";1==p&&(a.id=f.sa[u].id,t="/order/updateProcess");var i=[],n=[],o=[],r=[],d=[],l=[],s=[];$.each(e.find(".file-list-item"),function(e,a){var t=JSON.parse(decodeURI($(this).data("info")));i.push(t.realPath),n.push(t.originalFilename),o.push(t.url),r.push(t.uploadTime),d.push(t.uploader),l.push(t.fileSize),s.push(t.attachId||0)}),a.realPath=i.join(","),a.originalFilename=n.join(","),a.url=o.join(","),a.uploadTime=r.join(","),a.uploader=d.join(","),a.fileSize=l.join(","),a.attachId=s.join(","),a.callId=top.callId,app.loading(),$.post(t,a,function(e){"00"==e.error&&(layer.close(c),f.getCaseRecord(3),app.loading("close"))})}else layer.msg("请挂断电话之后再保存跟进记录")}})});break;case 1:a="/workBench/goOrderTask.do?orderId="+config.orderId+"&type="+f.type,1==p&&(a="/workBench/goOrderTask.do?id="+app.sb[u].id+"&orderId="+config.orderId+"&type="+app.type);layer.open({type:2,title:"案件报告",content:a,area:["600px","600px"]});break;case 5:if(1==p)app.$refs.payplan_edit.init(e);else app.$refs.payplan.init();break;case 2:a="/workBench/goOrderTask.do?orderId="+config.orderId+"&type=7&syMoney="+app.c.syMoney,1==p&&(a="/workBench/goOrderTask.do?id="+app.se[u].id+"&orderId="+config.orderId+"&type=7&syMoney="+app.c.syMoney);layer.open({type:2,title:"案件回款",content:a,area:["600px","600px"]})}},doTask:function(e){if(!(8==e&&1==this.precalc||5==e&&1==this.supplylaw))layer.open({type:2,title:"执行",content:"/workBench/goOrderTask.do?orderId="+config.orderId+"&type="+e,area:["600px","600px"]})},remind_add:function(){var t=this;require(["text!remind"],function(e){var a=layer.open({type:1,title:"新增提醒",closeBtn:1,content:e,area:["600px","300px"],btn:"保存",btnAlign:"c",success:function(){laydate.render({elem:"#remind_time"})},yes:function(){var e=$("#remind_box");""!=e.find("[name=remark]").val()?$.post(config.api_saveCallInfo,{orderId:config.orderId,remark:e.find("[name=remark]").val(),time:e.find("[name=time]").val()}).done(function(e){t.getCaseDetail(),layer.close(a)}):layer.msg("请填写提醒内容")}})})},remind_complete:function(e,a){var t=layer.confirm("确认完成?",function(){$.post(config.api_updateCallInfo,{id:a.id}).done(function(e){"00"==e.error?(a.flag=1,layer.close(t)):(layer.close(t),layer.msg(e.msg))})})},letter_add:function(){var e=encodeURI(JSON.parse(localStorage.userInfo).list[0].NAME),a=encodeURI(this.c.debtorName);layer.open({type:2,title:"新增函件",content:"/express/goAdd.do?orderId="+config.orderId+"&runnerName="+e+"&debtorName="+a,area:["90%","90%"]})},call_btn:function(e,a){var t=$(e.target);t.find("span").length&&0==a?t.find("span").show():1==a&&t.find("span").hide()},call:function(e,a){var t=this;this.record_add("call"),t.loading(),top.callId="",$.post(config.api_call,{orderId:config.orderId,mobilePhone:a}).done(function(e){t.loading("close")})},viewhj:function(e){layer.open({type:2,area:["90%","90%"],content:"/express/view.do?id="+e})},getNowFormatDate:function(){var e=new Date,a=e.getMonth()+1,t=e.getDate(),i=e.getHours(),n=e.getMinutes(),o=e.getSeconds();return 1<=a&&a<=9&&(a="0"+a),0<=t&&t<=9&&(t="0"+t),0<=i&&i<=9&&(i="0"+i),0<=n&&n<=9&&(n="0"+n),0<=o&&o<=9&&(o="0"+o),e.getFullYear()+"-"+a+"-"+t+" "+i+":"+n+":"+o}}})}),window.parentFnc=function(e){layer.closeAll(),window.app.getCaseRecord(window.app.type),window.app.getCaseDetail()};